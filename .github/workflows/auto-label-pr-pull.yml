name: Auto label pr-pull after brew test-bot

on:
  workflow_run:
    workflows: ["brew test-bot"]
    types:
      - completed

permissions:
  contents: read

jobs:
  label:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.HOMEBREW_TAP_APP_ID }}
          private-key: ${{ secrets.HOMEBREW_TAP_PRIVATE_KEY }}

      - name: Add pr-pull label (bot PRs only)
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const prs = context.payload.workflow_run.pull_requests || [];
            if (prs.length === 0) return;

            const prNumber = prs[0].number;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // SECURITY: Only auto-merge PRs opened by your GitHub App bot,
            // from a branch in THIS repo, matching your bump branch prefix.
            const login = pr.user?.login || "";
            const isReleaseBot = /^conn-castle-release-bot(\\[bot\\])?$/.test(login);
            const isSameRepo = pr.head?.repo?.full_name === `${context.repo.owner}/${context.repo.repo}`;
            const isBumpBranch = (pr.head?.ref || "").startsWith("bump-agent-layer-v");

            if (!isReleaseBot || !isSameRepo || !isBumpBranch) {
              core.info(`Not labeling PR #${prNumber}: login=${login}, sameRepo=${isSameRepo}, headRef=${pr.head?.ref}`);
              return;
            }

            // Avoid re-labeling if already present
            const labels = (pr.labels || []).map(l => l.name);
            if (labels.includes("pr-pull")) return;

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ["pr-pull"],
            });

            core.info(`Added pr-pull label to PR #${prNumber}`);
